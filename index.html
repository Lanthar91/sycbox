<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SYCBox</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>SYCBox</h1>
  <input type="file" id="romInput" accept=".nes">
  <button id="fullscreenBtn">Fullscreen</button>
  <canvas id="screen" width="256" height="240"></canvas>

  <script src="node_modules/jsnes/dist/jsnes.js"></script>
  <script>
    const canvas = document.getElementById("screen");
    const context = canvas.getContext("2d", { willReadFrequently: true });
    const romInput = document.getElementById("romInput");
    let romLoaded = false;

    const nes = new jsnes.NES({
      onFrame(frameBuffer) {
        const imageData = context.getImageData(0, 0, 256, 240);
        for (let i = 0; i < frameBuffer.length; i++) {
          imageData.data[i * 4] = frameBuffer[i] & 0xFF;
          imageData.data[i * 4 + 1] = (frameBuffer[i] >> 8) & 0xFF;
          imageData.data[i * 4 + 2] = (frameBuffer[i] >> 16) & 0xFF;
          imageData.data[i * 4 + 3] = 0xFF;
        }
        context.putImageData(imageData, 0, 0);
      },
      onAudioSample(left) {
        audioBuffer.push(left);
      },
      onStatusUpdate: console.log
    });

    function loadROM(buffer) {
      nes.loadROM(buffer);
      romLoaded = true;
      requestAnimationFrame(frameLoop);
    }

    romInput.addEventListener("change", function(event) {
      const reader = new FileReader();
      reader.onload = () => loadROM(reader.result);
      reader.readAsBinaryString(event.target.files[0]);
    });
const FPS = 60;
const interval = 1000 / FPS;
let lastTime = performance.now();

function frameLoop(currentTime) {
  const elapsed = currentTime - lastTime;

  if (elapsed >= interval) {
    if (romLoaded) nes.frame();
    lastTime = currentTime - (elapsed % interval);
  }

  requestAnimationFrame(frameLoop);
}

    document.getElementById("fullscreenBtn").onclick = () => canvas.requestFullscreen();

    // Аудио (работает отлично)
    let audioContext, scriptNode;
    const audioBuffer = [];

    function initAudio() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      scriptNode = audioContext.createScriptProcessor(2048, 0, 1);
      scriptNode.onaudioprocess = event => {
        const output = event.outputBuffer.getChannelData(0);
        if (audioBuffer.length >= 2048) {
          for (let i = 0; i < 2048; i++) output[i] = audioBuffer.shift();
        }
      };
      scriptNode.connect(audioContext.destination);
    }

    document.onclick = () => {
      if (!audioContext) initAudio();
      audioContext.resume();
    };

    // ---- Управление с клавиатуры, геймпада и пульта ТВ ----

    const BUTTONS = jsnes.Controller;

    const KEY_MAP = {
      38: BUTTONS.BUTTON_UP,     // ↑
      40: BUTTONS.BUTTON_DOWN,   // ↓
      37: BUTTONS.BUTTON_LEFT,   // ←
      39: BUTTONS.BUTTON_RIGHT,  // →
      90: BUTTONS.BUTTON_A,      // Z
      88: BUTTONS.BUTTON_B,      // X
      13: BUTTONS.BUTTON_START,  // Enter
      16: BUTTONS.BUTTON_SELECT, // Shift
      // Пульт ТВ
      461: BUTTONS.BUTTON_B,     // Назад (Back) на Tizen/WebOS
      415: BUTTONS.BUTTON_START, // Play на Tizen/WebOS
    };

    window.addEventListener("keydown", event => {
      const key = KEY_MAP[event.keyCode];
      if (key !== undefined) {
        nes.buttonDown(1, key);
        event.preventDefault();
      }
    });

    window.addEventListener("keyup", event => {
      const key = KEY_MAP[event.keyCode];
      if (key !== undefined) {
        nes.buttonUp(1, key);
        event.preventDefault();
      }
    });

    // --- Поддержка Xbox геймпада через Gamepad API ---

    const GAMEPAD_MAP = {
      12: BUTTONS.BUTTON_UP,    // D-pad вверх
      13: BUTTONS.BUTTON_DOWN,  // D-pad вниз
      14: BUTTONS.BUTTON_LEFT,  // D-pad влево
      15: BUTTONS.BUTTON_RIGHT, // D-pad вправо
      0: BUTTONS.BUTTON_A,      // A (Xbox)
      1: BUTTONS.BUTTON_B,      // B (Xbox)
      9: BUTTONS.BUTTON_START,  // Start/Menu (Xbox)
      8: BUTTONS.BUTTON_SELECT, // Select/View (Xbox)
    };

    function pollGamepad() {
      const gamepads = navigator.getGamepads();
      const gp = gamepads[0];
      if (!gp) return;

      gp.buttons.forEach((button, index) => {
        const nesButton = GAMEPAD_MAP[index];
        if (nesButton !== undefined) {
          if (button.pressed) nes.buttonDown(1, nesButton);
          else nes.buttonUp(1, nesButton);
        }
      });

      requestAnimationFrame(pollGamepad);
    }

    window.addEventListener("gamepadconnected", pollGamepad);
  </script>
</body>
</html>
